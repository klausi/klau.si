<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
  <head>
    <meta charset="utf-8" />
<meta name="Generator" content="Drupal 8 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<link rel="canonical" href="../node/37.html" />
<link rel="shortlink" href="../node/37.html" />
<link rel="revision" href="../node/37.html" />

    <title>A nginx configuration for Drupal | Klausi&#039;s Weblog</title>
    <link rel="stylesheet" media="all" href="../files/css/css_c8uKrkdw3uTl-xXgGz0TtfMpOZq9ps2b3GoXRcXqFfo.css%3Fprerue.css" />
<link rel="stylesheet" media="all" href="https://fonts.googleapis.com/css?family=Lato|Inconsolata|Merriweather:400,400italic,700,700italic&amp;subset=latin,latin-ext" />
<link rel="stylesheet" media="all" href="../files/css/css_nnYw3irVvzE0RwPEuTYB4Tml0tweJsM-gJZkF-TjK4U.css%3Fprerue.css" />

    
<!--[if lte IE 8]>
<script src="/files/js/js_VtafjXmRvoUgAzqzYTA3Wrjkx9wcWhjP0G4ZnnqRamA.js"></script>
<![endif]-->
<script src="../core/assets/vendor/modernizr/modernizr.min.js%3Fv=3.3.1"></script>

  </head>
  <body class="writer path-node page-node-type-story">
        <a href="82.html#main-content" class="visually-hidden focusable skip-link">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
    <div id="wrapper" class="wrapper" style="max-width: 630px;">
  
  <header role="banner" id="site-header">
  	<div class="head-wrap clearfix">
        <div class="region region-header">
    <div id="block-writer-branding" class="block block-system block-system-branding-block">
  
    
        <div class="logo-wrap">
      <a href="../index.html" title="Home" rel="home" id="logo">
        <img src="../files/uhura-drupal65_0.png" alt="Home" />
      </a>
    </div>
  
      <hgroup class="site-name-wrap">
              <h1 id="site-name">
          <a href="../index.html">Klausi&#039;s Weblog</a>
        </h1>
                    <h2 id="site-slogan">Trying to do a useful Blog</h2>
          </hgroup>
  </div>

  </div>

        <div class="region region-main-menu">
    <nav role="navigation" aria-labelledby="block-writer-main-menu-menu" id="block-writer-main-menu" class="block block-menu navigation menu--main">
            
  <h2 class="visually-hidden" id="block-writer-main-menu-menu">Main navigation</h2>
  

        
              <ul class="menu">
                    <li class="menu-item">
        <a href="../node/50.html" title="Drupal development setup on Ubuntu" data-drupal-link-system-path="node/50">Drupal dev on Ubuntu</a>
              </li>
                <li class="menu-item">
        <a href="../rss.xml" title="Subscribe to this feed to get updates on new blog posts" data-drupal-link-system-path="rss.xml">RSS feed</a>
              </li>
                <li class="menu-item">
        <a href="../node/51.html" data-drupal-link-system-path="node/51">speaking</a>
              </li>
                <li class="menu-item">
        <a href="../node/1.html" data-drupal-link-system-path="node/1">about</a>
              </li>
                <li class="menu-item">
        <a href="../node/53.html" title="contact klausi" data-drupal-link-system-path="node/53">contact</a>
              </li>
        </ul>
  


  </nav>

  </div>

	  </div>
  </header>

  

  
  <main role="main" class="main-content">
  	<a id="main-content"></a>
          <div id="highlighted">  <div class="region region-highlighted">
    <div data-drupal-messages-fallback class="hidden"></div>

  </div>
</div>
    
    
        

    
    

    
      <div class="region region-content">
    <div id="block-writer-page-title" class="block block-core block-page-title-block">
  
    
      
  <h1 class="page-title"><span class="field field--name-title field--type-string field--label-hidden">A nginx configuration for Drupal</span>
</h1>


  </div>
<div id="block-writer-easybreeze-system-main" class="block block-system block-system-main-block">
  
    
      
<article id="node-37" class=" " role="article" >

  <header>
    

    
          <div class="meta">
        <time class="submitted writer-date" datetime="2011-05-23 17:05:36" pubdate="pubdate">23 May 2011</time>
      </div>
    
  </header>

  <div class="node-main contextual-region">

    

    <div >
            
            <div class="clearfix text-formatted field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>While nginx is highly configurable, you might encounter some problems and pitfalls when configuring it with Drupal. This post contains our configuration and solutions to those problems.</p>
<!--break--><p>Before reading on please consider the original <a href="http://wiki.nginx.org/Drupal">resources in the nginx wiki</a> or some other suggested configurations, e.g. this <a href="https://github.com/omega8cc/nginx-for-drupal/blob/master/aegir/conf/nginx_octopus_include.conf">one on Github</a>. Some problems we found:</p>
<ul><li>
		nginx does extra URL encoding when passing query parameters to Drupal. This is bad especially for "+" characters in queries that do not translate to spaces in Drupal (as <a href="http://www.dmuth.org/node/1268">reported here</a>). Therefore we cannot use the generic "location /" directive but use a generic regular expression to extract the query, in this case the "$1" variable is not encoded by nginx.</li>
<li>
		Private files cannot be downloaded fluently, i.e. they often pause for 30 seconds before they continue. It seems to be a problem related to HTTP keep-alive connections, because disabling them with "keepalive_requests 0;" solved the issue.</li>
<li>
		Image cache may cause problems if the images are not generated yet, so an additional "try_files $uri @drupal" statement for images redirects the request to Drupal in case an image is not found. Also works for Drupal 7, where image cache is part of Drupal core.</li>
</ul><p>The strategy in the configuration is to first handle/secure files (robots.txt, PHP files), then protect or configure other relevant paths and to have a catch-all directive at the end. Here is the content of drupal.conf that can be included in a "server{}" block:</p>
<pre>
# common Drupal configuration options.
# Make sure to set $socket to a fastcgi socket.

        location = /favicon.ico {
                log_not_found off;
                access_log off;
        }

        ###
        ### support for http://drupal.org/project/robotstxt module
        ###
        location = /robots.txt {
                access_log off;
                try_files $uri @drupal;
        }

        # no access to php files in subfolders.
        location ~ .+/.*\.php$ {
                return 403;
        }

        location ~* \.(inc|engine|install|info|module|sh|sql|theme|tpl\.php|xtmpl|Entries|Repository|Root|jar|java|class)$ {
                deny all;
        }

        location ~ \.php$ {
                # Required for private files, otherwise they slow down extremely.
                keepalive_requests 0;
                include fastcgi.conf;
        }

        # private files protection
        location ~ ^/sites/.*/private/ {
                access_log off;
                deny all;
        }

        location ~* ^(?!/system/files).*\.(js|css|png|jpg|jpeg|gif|ico)$ {
                # If the image does not exist, maybe it must be generated by drupal (imagecache)
                try_files $uri @drupal;
                expires 7d;
                log_not_found off;
        }

        ###
        ### deny direct access to backups
        ###
        location ~* ^/sites/.*/files/backup_migrate/ {
                access_log off;
                deny all;
        }

        location ~ ^/(.*) {
                try_files $uri /index.php?q=$1&amp;$args;
        }

        location @drupal {
                # Some modules enforce no slash (/) at the end of the URL
                # Else this rewrite block wouldn't be needed (GlobalRedirect)
                rewrite ^/(.*)$ /index.php?q=$1;
        }
</pre><p>And here is the configuration for passing the request to PHP FastCGI (fastcgi.conf):</p>
<pre>
# common fastcgi configuration for PHP files

                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                #NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
                include fastcgi_params;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_intercept_errors on;
                fastcgi_pass $socket;
                # workaround as fastcgi_param cannot be used inside if statements
                set $https "";
                if ($scheme = https) {
                  set $https on;
                }
                fastcgi_param HTTPS $https;
                fastcgi_read_timeout 6000;
                # set expires header for private files.
                if ($args ~* \.(js|css|png|jpg|jpeg|gif|ico)) {
                    expires 7d;
                }</pre><p> </p>
</div>
      
  <div class="field field--name-taxonomy-vocabulary-1 field--type-entity-reference field--label-above">
    <div class="field__label">Categories</div>
          <div class="field__items">
              <div class="field__item"><a href="../taxonomy/term/6.html" hreflang="en">Drupal</a></div>
          <div class="field__item"><a href="../taxonomy/term/7.html" hreflang="en">Drupal planet</a></div>
              </div>
      </div>
<section class="comments field field--name-comment-node-story field--type-comment field--label-above comment-wrapper">
      
    <h2 class="title">Comments</h2>
    
  
  <article  data-comment-user-id="0" id="comment-81" class="comment">
  
  <h3><a href="81.html#comment-81" class="permalink" rel="bookmark" hreflang="en">This configuration is vulnerable to the php try_files bug</a></h3>
  

  <div class="submitted">On <time datetime="2011-05-23 19:32:05">23 May 2011</time>, <a rel="nofollow" href="http://www.typofree.org" class="username">Michiel Roos</a> said...</div>
    
  <div>
        
            <div class="clearfix text-formatted field field--name-comment-body field--type-text-long field--label-hidden field__item"><p>
	You should always check if a file passed to the php handler actually exists before passing it to the php socket. If you don't, people can upload a file called lala.gif containing a php script and then request something like /uploads/lala.gif/dud.php. The contents of lala.gif will then be executed as php.</p>
<p>
	<a href="https://nealpoole.com/blog/2011/04/setting-up-php-fastcgi-and-nginx-dont-trust-the-tutorials-check-your-configuration/">https://nealpoole.com/blog/2011/04/setting-up-php-fastcgi-and-nginx-don…</a></p>
<p>
	Add a</p>

try_files $uri =404;<p>
	At the top of the php fastcgi block</p></div>
      

    
    </div>

  <ul class="links inline"><li class="comment-forbidden"></li></ul>
</article>

<div class="indented"><article  data-comment-user-id="1" id="comment-82" class="comment">
  
  <h3><a href="82.html#comment-82" class="permalink" rel="bookmark" hreflang="en">Thanks for that tip, but in</a></h3>
  

  <div class="submitted">On <time datetime="2011-05-23 21:46:17">23 May 2011</time>, <span>klausi</span> said...</div>
        <p class="parent visually-hidden">In reply to <a href="81.html#comment-81" class="permalink" rel="bookmark" hreflang="en">This configuration is vulnerable to the php try_files bug</a> by <a rel="nofollow" href="http://www.typofree.org" class="username">Michiel Roos</a></p>
  
  <div>
        
            <div class="clearfix text-formatted field field--name-comment-body field--type-text-long field--label-hidden field__item"><p>Thanks for that tip, but in our configuration PHP files execution is explicitly forbidden in any subfolder. Even if a malicious image is uploaded, it cannot get to the document root. Even if it gets somehow to the document root, it cannot be executed as PHP file, because one has to add a "/dud.php" to the path and the first rule prevents executing PHP files in subfolders again.</p>
<p>So this config is perfectly safe.</p></div>
      

    
    </div>

  <ul class="links inline"><li class="comment-forbidden"></li></ul>
</article>
</div><article  data-comment-user-id="0" id="comment-87" class="comment">
  
  <h3><a href="87.html#comment-87" class="permalink" rel="bookmark" hreflang="en">sub-dirs</a></h3>
  

  <div class="submitted">On <time datetime="2011-07-15 11:34:51">15 Jul 2011</time>, <a rel="nofollow" href="http://wolfgangziegler.net" class="username">fago</a> said...</div>
    
  <div>
        
            <div class="clearfix text-formatted field field--name-comment-body field--type-text-long field--label-hidden field__item"><p>
	I just came over the need of having clean-URLs for Drupal installations in  sub-directories. See <a href="http://wolfgangziegler.net/nginx-drupal-clean-urls-sub-directories">here</a>.</p></div>
      

    
    </div>

  <ul class="links inline"><li class="comment-forbidden"></li></ul>
</article>
<article  data-comment-user-id="0" id="comment-88" class="comment">
  
  <h3><a href="88.html#comment-88" class="permalink" rel="bookmark" hreflang="en">No need to use PATH_INFO</a></h3>
  

  <div class="submitted">On <time datetime="2011-07-19 16:43:17">19 Jul 2011</time>, <span>perusio</span> said...</div>
    
  <div>
        
            <div class="clearfix text-formatted field field--name-comment-body field--type-text-long field--label-hidden field__item"><p>
	Drupal does not rely on PATH_INFO (contrary to WP for example). You're exposing yourself to the cgi.fix_pathinfo "bug" that has bitten numerous WP sites by making use of it and got hacked. Also the private files can be handled in a much smarter way by using: <a href="http://wiki.nginx.org/X-accel">http://wiki.nginx.org/X-accel</a>. There's even a drupal module for it ;)</p></div>
      

    
    </div>

  <ul class="links inline"><li class="comment-forbidden"></li></ul>
</article>
<article  data-comment-user-id="0" id="comment-91" class="comment">
  
  <h3><a href="91.html#comment-91" class="permalink" rel="bookmark" hreflang="en">Barracuda</a></h3>
  

  <div class="submitted">On <time datetime="2011-10-26 00:39:32">26 Oct 2011</time>, <a rel="nofollow" href="http://www.attiks.com" class="username">attiks</a> said...</div>
    
  <div>
        
            <div class="clearfix text-formatted field field--name-comment-body field--type-text-long field--label-hidden field__item"><p>Have a look at the config file of barracuda project it has lots of good stuff: <a href="http://drupalcode.org/project/barracuda.git/blob/HEAD:/aegir/conf/nginx_advanced_include.conf">http://drupalcode.org/project/barracuda.git/blob/HEAD:/aegir/conf/nginx…</a></p></div>
      

    
    </div>

  <ul class="links inline"><li class="comment-forbidden"></li></ul>
</article>


  
</section>

    </div>

          <footer class="link-wrapper">
          <div class="node__links">
    <ul class="links inline"><li class="comment-forbidden"></li></ul>  </div>

      </footer>
    
    
  </div>

</article>

  </div>

  </div>

  </main>

  <footer class="page-footer">
  	  <div class="region region-footer-top">
    <nav role="navigation" aria-labelledby="block-categories-menu" id="block-categories" class="block block-menu navigation menu--secondary-menu">
      
  <h2 id="block-categories-menu">Categories</h2>
  

        
              <ul class="menu">
                    <li class="menu-item">
        <a href="../taxonomy/term/6.html" title="
" data-drupal-link-system-path="taxonomy/term/6">Drupal</a>
              </li>
                <li class="menu-item">
        <a href="../taxonomy/term/1.html" title="" data-drupal-link-system-path="taxonomy/term/1">Freizeit</a>
              </li>
                <li class="menu-item">
        <a href="../taxonomy/term/2.html" title="" data-drupal-link-system-path="taxonomy/term/2">Gesellschaftskritik</a>
              </li>
                <li class="menu-item">
        <a href="../taxonomy/term/3.html" title="" data-drupal-link-system-path="taxonomy/term/3">Software</a>
              </li>
                <li class="menu-item">
        <a href="../taxonomy/term/5.html" title="" data-drupal-link-system-path="taxonomy/term/5">Uni</a>
              </li>
                <li class="menu-item">
        <a href="../taxonomy/term/4.html" title="" data-drupal-link-system-path="taxonomy/term/4">Uncategorized</a>
              </li>
        </ul>
  


  </nav>
<div id="block-writer-easybreeze-block-3" class="block block-block-content block-block-content31e9598c-b49e-4c82-af38-e5c72a6fb0c7">
  
    
      
            <div class="clearfix text-formatted field field--name-body field--type-text-with-summary field--label-hidden field__item"><p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work by <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">Klaus Purer</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
</div>
      
  </div>

  </div>

  	  	
  	<div class="foot-wrap clearfix">
                </div>
  </footer>
</div> <!-- end wrapper -->

  </div>

    
    <script type="application/json" data-drupal-selector="drupal-settings-json">{"path":{"baseUrl":"\/","scriptPath":null,"pathPrefix":"","currentPath":"comment\/82","currentPathIsAdmin":false,"isFront":false,"currentLanguage":"en","currentQuery":{"page":0}},"pluralDelimiter":"\u0003","user":{"uid":0,"permissionsHash":"e96a7765a53cb802146dc48da3834d3a470ce957d28868afe583adf3bec8d6c5"}}</script>
<script src="../files/js/js_JdSNpE3Gh7Tv0XWwuGvbXkjYUqrXVCBIZ_Pf8-3EN4M.js"></script>

  </body>
</html>
