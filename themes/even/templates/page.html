{% extends "index.html" %}
{% import "post_macros.html" as post_macros %}

{% block title %}
  {{ config.title }} - {{ page.title }}
{% endblock title %}

{% block extra_head %}
  {# OpenGraph meta tags #}
  <meta property="og:title" content="{{ page.title }}">
  <meta property="og:type" content="article">
  <meta property="og:url" content="{{ page.permalink | safe }}">
  {% if page.description %}
    <meta property="og:description" content="{{ page.description }}">
  {% elif page.summary %}
    <meta property="og:description" content="{{ page.summary | striptags | truncate(length=200) }}">
  {% endif %}
  <meta property="og:site_name" content="{{ config.title }}">
  {% if page.date %}
    <meta property="article:published_time" content="{{ page.date }}">
  {% endif %}

  {# Determine og:image - check for YouTube thumbnail first, then first image in content, then fallback to logo #}
  {% set og_image = "" %}

  {# Check for YouTube shortcode - extract video ID from rendered content #}
  {% if page.content is containing("data-video-id=") %}
    {# Extract the line containing data-video-id and get the ID #}
    {% set content_after_marker = page.content | split(pat='data-video-id="') %}
    {% if content_after_marker | length > 1 %}
      {% set video_id_part = content_after_marker[1] | split(pat='"') | first %}
      {% if video_id_part %}
        {% set og_image = get_url(path="youtube-thumbs/" ~ video_id_part ~ ".webp") %}
      {% endif %}
    {% endif %}
  {% endif %}

  {# If no YouTube, check for first image in content #}
  {% if og_image == "" and page.content is containing(' src="') %}
    {# Extract the first src attribute value #}
    {% set content_after_src = page.content | split(pat=' src="') %}
    {% if content_after_src | length > 1 %}
      {% set img_src = content_after_src[1] | split(pat='"') | first %}
      {% if img_src %}
        {# Handle relative URLs - make them absolute #}
        {% if img_src is starting_with("http") %}
          {% set og_image = img_src %}
        {% elif img_src is starting_with("/") %}
          {% set og_image = config.base_url ~ img_src %}
        {% else %}
          {# Relative to page path - construct full URL #}
          {% set page_dir = page.permalink | trim_end_matches(pat="/") %}
          {% set og_image = page_dir ~ "/" ~ img_src %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}

  {# Fallback to site logo #}
  {% if og_image == "" %}
    {% set og_image = get_url(path="logo.webp") %}
  {% endif %}

  <meta property="og:image" content="{{ og_image | safe }}">
{% endblock extra_head %}

{% block content %}

  {% if page.toc %}
    <div class="post-toc" id="post-toc">
      <h2 class="post-toc-title">Contents</h2>
      <div class="post-toc-content always-active">
        <nav id="TableOfContents">
          <ul>
            {% for h1 in page.toc %}
              <li>
                <a href="{{ h1.permalink | safe }}" class="toc-link">{{ h1.title }}</a>
                {% if h1.children %}
                  <ul>
                    {% for h2 in h1.children %}
                      <li>
                        <a href="{{ h2.permalink | safe }}" class="toc-link">{{ h2.title }}</a>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </nav>
      </div>
    </div>
  {% endif %}

  <article class="post">
    {{ post_macros::title(page=page, link=false) }}
    <div class="post-content">{{ page.content | safe }}</div>

    {% block page_before_footer %}
    {% endblock page_before_footer %}

    <div class="post-footer">
      {% block page_footer %}
        {% if page.taxonomies.tags %}
          <div class="post-tags">
            {% for tag in page.taxonomies.tags %}
              <a href="{{ get_taxonomy_url(kind='tags', name=tag) }}">#{{ tag }}</a>
            {% endfor %}
          </div>
        {% endif %}

      {% endblock page_footer %}

    </div>

    {% block page_after_footer %}
    {% endblock page_after_footer %}
  </article>

{% endblock content %}
