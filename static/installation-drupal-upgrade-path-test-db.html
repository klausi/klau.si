<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
  <head>
    <meta charset="utf-8" />
<meta name="Generator" content="Drupal 8 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<link rel="canonical" href="node/41.html" />
<link rel="shortlink" href="node/41.html" />
<link rel="revision" href="node/41.html" />

    <title>Installation of a Drupal Upgrade Path Test DB | Klausi&#039;s Weblog</title>
    <link rel="stylesheet" media="all" href="files/css/css_c8uKrkdw3uTl-xXgGz0TtfMpOZq9ps2b3GoXRcXqFfo.css%3Fprerue.css" />
<link rel="stylesheet" media="all" href="https://fonts.googleapis.com/css?family=Lato|Inconsolata|Merriweather:400,400italic,700,700italic&amp;subset=latin,latin-ext" />
<link rel="stylesheet" media="all" href="files/css/css_nnYw3irVvzE0RwPEuTYB4Tml0tweJsM-gJZkF-TjK4U.css%3Fprerue.css" />

    
<!--[if lte IE 8]>
<script src="/files/js/js_VtafjXmRvoUgAzqzYTA3Wrjkx9wcWhjP0G4ZnnqRamA.js"></script>
<![endif]-->
<script src="core/assets/vendor/modernizr/modernizr.min.js%3Fv=3.3.1"></script>

  </head>
  <body class="writer path-node page-node-type-story">
        <a href="node/41.html#main-content" class="visually-hidden focusable skip-link">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
    <div id="wrapper" class="wrapper" style="max-width: 630px;">
  
  <header role="banner" id="site-header">
  	<div class="head-wrap clearfix">
        <div class="region region-header">
    <div id="block-writer-branding" class="block block-system block-system-branding-block">
  
    
        <div class="logo-wrap">
      <a href="index.html" title="Home" rel="home" id="logo">
        <img src="files/uhura-drupal65_0.png" alt="Home" />
      </a>
    </div>
  
      <hgroup class="site-name-wrap">
              <h1 id="site-name">
          <a href="index.html">Klausi&#039;s Weblog</a>
        </h1>
                    <h2 id="site-slogan">Trying to do a useful Blog</h2>
          </hgroup>
  </div>

  </div>

        <div class="region region-main-menu">
    <nav role="navigation" aria-labelledby="block-writer-main-menu-menu" id="block-writer-main-menu" class="block block-menu navigation menu--main">
            
  <h2 class="visually-hidden" id="block-writer-main-menu-menu">Main navigation</h2>
  

        
              <ul class="menu">
                    <li class="menu-item">
        <a href="node/50.html" title="Drupal development setup on Ubuntu" data-drupal-link-system-path="node/50">Drupal dev on Ubuntu</a>
              </li>
                <li class="menu-item">
        <a href="rss.xml" title="Subscribe to this feed to get updates on new blog posts" data-drupal-link-system-path="rss.xml">RSS feed</a>
              </li>
                <li class="menu-item">
        <a href="node/51.html" data-drupal-link-system-path="node/51">speaking</a>
              </li>
                <li class="menu-item">
        <a href="node/1.html" data-drupal-link-system-path="node/1">about</a>
              </li>
                <li class="menu-item">
        <a href="node/53.html" title="contact klausi" data-drupal-link-system-path="node/53">contact</a>
              </li>
        </ul>
  


  </nav>

  </div>

	  </div>
  </header>

  

  
  <main role="main" class="main-content">
  	<a id="main-content"></a>
          <div id="highlighted">  <div class="region region-highlighted">
    <div data-drupal-messages-fallback class="hidden"></div>

  </div>
</div>
    
    
        

    
    

    
      <div class="region region-content">
    <div id="block-writer-page-title" class="block block-core block-page-title-block">
  
    
      
  <h1 class="page-title"><span class="field field--name-title field--type-string field--label-hidden">Installation of a Drupal Upgrade Path Test DB</span>
</h1>


  </div>
<div id="block-writer-easybreeze-system-main" class="block block-system block-system-main-block">
  
    
      
<article id="node-41" class=" " role="article" >

  <header>
    

    
          <div class="meta">
        <time class="submitted writer-date" datetime="2012-03-31 17:48:04" pubdate="pubdate">31 Mar 2012</time>
      </div>
    
  </header>

  <div class="node-main contextual-region">

    

    <div >
            
            <div class="clearfix text-formatted field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>While working on the <a href="http://drupal.org/node/935062">Kill role IDs patch</a> I had to develop some upgrade path Simpletests. Unfortunately the <a href="http://drupal.org/node/1429136">documentation for upgrade path tests</a> currently lacks installtion instructions on how to work with the existing bare and filled exported test databases. Here is a small writeup of what I did until we document that properly.</p>
<!--break--><p>The test databases are exported to executable PHP code and live in core/modules/simpletest/tests/upgrade (Drupal 8). The problem is that you needed a bootstrapped Drupal database system to run those statements and an empty database at the same time where you insert the data. So first you need to create a new, empty development environment - not only a new site in a multi-site setup in your usual development directory.</p>
<ul><li>
		Checkout Drupal core (7.x in my case) in a separate directory, create a new database, setup your web server (this empty instance is called d7upgrade.localhost on my machine).</li>
<li>
		You will also need an existing Drupal 7/8 installation, you can just use any development site you already have (this instance is called drupal-8.localhost on my machine).</li>
<li>
		Extract the zipped drupal-7.bare.database.php.gz or drupal-7.filled.database.php.gz in drupal-8/core/modules/simpletest/tests/upgrade: <code>gunzip drupal-7.bare.database.php.gz</code></li>
<li>
		Add database credentials for the d7upgrade database to settings.php of drupal-8.localhost:<br /><div class="codeblock nowrap-expand"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />$databases</span><span style="color: #007700">[</span><span style="color: #DD0000">'d7upgrade'</span><span style="color: #007700">][</span><span style="color: #DD0000">'default'</span><span style="color: #007700">] = array (<br />  </span><span style="color: #DD0000">'database' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'d7upgrade'</span><span style="color: #007700">,<br />  </span><span style="color: #DD0000">'username' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'root'</span><span style="color: #007700">,<br />  </span><span style="color: #DD0000">'password' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">''</span><span style="color: #007700">,<br />  </span><span style="color: #DD0000">'host' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'localhost'</span><span style="color: #007700">,<br />  </span><span style="color: #DD0000">'port' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">''</span><span style="color: #007700">,<br />  </span><span style="color: #DD0000">'driver' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'mysql'</span><span style="color: #007700">,<br />  </span><span style="color: #DD0000">'prefix' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">''</span><span style="color: #007700">,<br />);<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
</li>
<li>
		Create a small PHP script called import.php somewhere in drupal-8 that will insert the data to d7upgrade:<br /><div class="codeblock nowrap-expand"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />db_set_active</span><span style="color: #007700">(</span><span style="color: #DD0000">'d7upgrade'</span><span style="color: #007700">);<br />require </span><span style="color: #DD0000">'/home/klausi/workspace/drupal-8/core/modules/simpletest/tests/upgrade/drupal-7.bare.database.php'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
</li>
<li>
		Execute the script with drush somewhere in drupal-8: <code>drush php-script import.php</code></li>
<li>
		Now the d7upgrade database should be filled. Go to d7upgrade.localhost in your browser and install Drupal, after entering the database credentials you should get to an existing site.</li>
<li>
		Login as admin with user: drupal and password: drupal. Make changes to the installation that you need for your upgrade test (e.g. I added some user roles that I wanted to do tests with).</li>
<li>
		Export the modified database (you need to run that from the root of your d7upgrade installation): <code>php scripts/dump-database-d7.sh &gt; d7upgrade.php</code></li>
<li>
		Examine the differences of your export to the original export (note: you will see quite some unrelated changes as the original export may not be fully up to date): <code>diff d7upgrade.php /home/klausi/workspace/drupal-8/core/modules/simpletest/tests/upgrade/drupal-7.bare.database.php | less</code></li>
<li>
		Copy your modifications to a separate PHP file, as for example done in drupal-7-language.php. By doing that you avoid to have another big full database export and you can reuse drupal-7.bare.database.php.gz or drupal-7.filled.database.php.gz in your UpgradePathTestCase::setUp() (see upgrade.language.test for an example).</li>
</ul><p>Doing all this is ugly and I'm not sure this is the way it should be done. Leave a comment or contact me if you know better.</p>
</div>
      
  <div class="field field--name-taxonomy-vocabulary-1 field--type-entity-reference field--label-above">
    <div class="field__label">Categories</div>
          <div class="field__items">
              <div class="field__item"><a href="taxonomy/term/6.html" hreflang="en">Drupal</a></div>
          <div class="field__item"><a href="taxonomy/term/7.html" hreflang="en">Drupal planet</a></div>
              </div>
      </div>
<section class="comments field field--name-comment-node-story field--type-comment field--label-above comment-wrapper">
  
  

  
</section>

    </div>

          <footer class="link-wrapper">
          <div class="node__links">
    <ul class="links inline"><li class="comment-forbidden"></li></ul>  </div>

      </footer>
    
    
  </div>

</article>

  </div>

  </div>

  </main>

  <footer class="page-footer">
  	  <div class="region region-footer-top">
    <nav role="navigation" aria-labelledby="block-categories-menu" id="block-categories" class="block block-menu navigation menu--secondary-menu">
      
  <h2 id="block-categories-menu">Categories</h2>
  

        
              <ul class="menu">
                    <li class="menu-item">
        <a href="taxonomy/term/6.html" title="
" data-drupal-link-system-path="taxonomy/term/6">Drupal</a>
              </li>
                <li class="menu-item">
        <a href="taxonomy/term/1.html" title="" data-drupal-link-system-path="taxonomy/term/1">Freizeit</a>
              </li>
                <li class="menu-item">
        <a href="taxonomy/term/2.html" title="" data-drupal-link-system-path="taxonomy/term/2">Gesellschaftskritik</a>
              </li>
                <li class="menu-item">
        <a href="taxonomy/term/3.html" title="" data-drupal-link-system-path="taxonomy/term/3">Software</a>
              </li>
                <li class="menu-item">
        <a href="taxonomy/term/5.html" title="" data-drupal-link-system-path="taxonomy/term/5">Uni</a>
              </li>
                <li class="menu-item">
        <a href="taxonomy/term/4.html" title="" data-drupal-link-system-path="taxonomy/term/4">Uncategorized</a>
              </li>
        </ul>
  


  </nav>
<div id="block-writer-easybreeze-block-3" class="block block-block-content block-block-content31e9598c-b49e-4c82-af38-e5c72a6fb0c7">
  
    
      
            <div class="clearfix text-formatted field field--name-body field--type-text-with-summary field--label-hidden field__item"><p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work by <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">Klaus Purer</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
</div>
      
  </div>

  </div>

  	  	
  	<div class="foot-wrap clearfix">
                </div>
  </footer>
</div> <!-- end wrapper -->

  </div>

    
    <script src="files/js/js_SAbF7_9D3ptKNhENvJKfwyi_T5kAVm_Ix6s6XYDiJhg.js"></script>

  </body>
</html>
